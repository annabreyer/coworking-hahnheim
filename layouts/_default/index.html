{{ define "main" }}
{{ $headless := .GetPage "./homepage" }}
{{ $sections := $headless.Resources.ByType "page" }}
{{ $sections := cond .Site.BuildDrafts $sections (where $sections "Draft" "==" false) }}
{{ $content := where (where $sections "Params.external" "==" nil) "Params.detailed_page_homepage_content" "ne" false }}
{{ $translations := .Page.AllTranslations }}

<!-- Welcome screen with enhanced header -->
{{ if not .Params.header_use_video }}
{{ with $img := resources.Get .Params.header_image }}
{{ $image_options := $.Site.Params.image_options | default "webp q90 lanczos photo" -}}
<style>
    /* Default cover for larger screens, converted to webp */
    {{- with $img.Resize ( printf "%dx%d %s" $img.Width $img.Height $image_options ) -}}
    #site-head.withCenteredImage {
        background-image: url('{{- .RelPermalink -}}');
    }
    {{- end -}}

    /*
    Lower resolutions, uncropped. Aimed at desktop users.
    We set __both__ max-width and max-height to make sure the image is never upscaled.
    */
    {{ range $width := slice 1920 1600 1366 }}
    {{- with $img.Resize ( printf "%dx %s" $width $image_options ) }}
    @media (max-width: {{- .Width -}}px) and (max-height: {{- .Height -}}px) {
    #site-head.withCenteredImage { background-image: url('{{- .RelPermalink -}}'); }
    }
    {{- end }}
    {{- end }}

    /*
    Lower resolutions, cropped to portrait. Useful for mobile. For "tall" displays (screen ratio < image ratio)
    the "cover" algorithm first resizes the image to match the screen height, then __crops__ it to match the width.
    We mimic this by resizing to height=1024, and then cropping to various widths. We set "max-height" to
    ensure the height is never upscaled, but also max-aspect-ratio to ensure that each image is used in "tall-enough"
    displays, in which our cropping would happen anyways!
    */
    {{- $img_temp := $img.Resize "x1024 q100" -}}/* high quality temporary image, to be cropped later */
    {{ range $width := slice 900 600 360 }}
    {{- with $img_temp.Crop ( printf "%dx1024 center %s" $width $image_options ) }}
    @media (max-height: {{- .Height -}}px) and (max-aspect-ratio: {{ .Width }} / {{ .Height }}) {
    #site-head.withCenteredImage { background-image: url('{{- .RelPermalink -}}'); }
    }
    {{- end }}
    {{- end }}
</style>
{{ end }}
<header id="site-head" class="withCenteredImage homepage-hero">
    {{ else }}
    <header id="site-head" class="homepage-hero">
        {{ end }}

        <div class="vertical">

            {{ if .Params.header_use_video }}
            {{- partial "custom_header_video.html" . -}}
            {{ end }}

            {{ $num_lang := len $translations }}
            {{ if and (gt $num_lang 1) $.Site.Params.language_menu }}
            <div id="site-languages" class="inner">
                {{ range $translations }}
                {{ $lang_title := or .Language.LanguageName (.Lang | strings.ToUpper) }}
                {{ if eq .Lang $.Lang }}
                {{ if $.Site.Params.show_current_lang }}
                <span class='btn-lang active'>{{ $lang_title }}</span>
                {{ end }}
                {{ else }}
                <a class='btn-lang' href='{{ .RelPermalink }}'>{{ $lang_title }}</a>
                {{ end }}
                {{ end }}
            </div>
            {{ end }}

            <div id="site-head-content" class="inner">
                <div id="side-header-title-button" class="inner">
                    {{ with resources.Get .Params.header_logo }}<img id="blog-logo" alt="" src="{{ .RelPermalink }}" />{{ end }}

                    {{ if .Site.Params.title_guard }}<div class="title-and-description-guard">{{ end }}
                    {{ with .Params.header_headline }}<h1 class="blog-title">{{ . | safeHTML }}</h1>{{ end }}
                    {{ with .Params.header_sub_headline }}<h2 class="blog-description">{{ . | safeHTML }}</h2>{{ end }}
                    {{ if .Site.Params.title_guard }}</div>{{ end }}

                    {{ range where $sections ".Params.header_menu" "eq" true }}
                    {{ $button_title := .Title }}
                    {{ with .Params.header_menu_title }}{{ $button_title = . }}{{ end }}

                    {{ if isset .Params "external" }}
                    <a class='btn site-menu' href='{{ .Params.external | absURL }}'>{{ $button_title }}&nbsp;<i class="fa fa-external-link"></i></a>
                    {{ else if isset .Params "detailed_page_path" }}
                    <a class='btn site-menu' href='{{ .Params.detailed_page_path | relURL }}'>{{ $button_title }}</a>
                    {{ else }}
                    {{ $fnav_title := .Title }}{{ with .Params.navigation_menu_title }}{{ $fnav_title = . }}{{ end }}
                    <a class='btn site-menu' data-title-anchor='{{ anchorize $fnav_title }}' href='#{{ anchorize $fnav_title }}'>{{ $button_title }}</a>
                    {{ end }}
                    {{ end }}

                    {{ with (index $content 0) }}
                    {{ $first_title := .Title }}{{ with .Params.navigation_menu_title }}{{ $first_title = . }}{{ end }}
                    <a id='header-arrow' href="#{{- anchorize $first_title -}}" aria-label="Go to first section"><i class="fa fa-angle-down"></i></a>
                    {{ end }}
                </div>
            </div>
        </div>
    </header>

    <!-- Sticky Navigation for Homepage -->
    <nav class="homepage-sticky-nav" id="homepageNav">
        <div class="sticky-nav-content">
            <a href="{{ "/" | relURL }}" class="nav-logo">
            {{ with resources.Get .Site.Params.header_logo }}
            <img src="{{ .RelPermalink }}" alt="{{ $.Site.Title }}" />
            {{ end }}
            <span>{{ .Site.Params.header_headline | safeHTML }}</span>
            </a>

            <ul class="sticky-nav-menu">
                {{ range where $sections ".Params.header_menu" "eq" true }}
                {{ $button_title := .Title }}
                {{ with .Params.header_menu_title }}{{ $button_title = . }}{{ end }}
                {{ $fnav_title := .Title }}{{ with .Params.navigation_menu_title }}{{ $fnav_title = . }}{{ end }}

                {{ if isset .Params "external" }}
                <li><a href='{{ .Params.external | absURL }}' target="_blank">{{ $button_title }}&nbsp;<i class="fa fa-external-link"></i></a></li>
                {{ else }}
                <li><a href='#{{ anchorize $fnav_title }}'>{{ $button_title }}</a></li>
                {{ end }}
                {{ end }}
            </ul>

            <button class="mobile-nav-toggle" id="mobileNavToggle">
                <span></span>
                <span></span>
                <span></span>
            </button>
        </div>
    </nav>

    <main class="content" role="main">
        <!-- Enhanced left navigation menu -->
        <div class='fixed-nav enhanced-nav'>
            {{ if eq .Params.nav_to_top_weight "first" }}
            {{ $fnav_title := "Start" }}{{ with .Params.nav_to_top_title }}{{ $fnav_title = . }}{{ end }}
            <a class='fn-item' item_index='{{ 0 }}' href='./#site-head'>
                <i class="fas fa-arrow-up"></i>
                <span>{{ $fnav_title | safeHTML }}</span>
            </a>
            {{ end }}
            {{ $last_index_val := 0 }}
            {{ range $index_val, $elem_val := $content }}
            {{ $fnav_title := .Title }}{{ with .Params.navigation_menu_title }}{{ $fnav_title = . }}{{ end }}
            <a class='fn-item' item_index='{{ (add $index_val 1) }}' href='#{{ anchorize $fnav_title }}'>
                <i class="{{ .Params.nav_icon | default "fas fa-circle" }}"></i>
                <span>{{ $fnav_title | safeHTML }}</span>
            </a>
            {{ $last_index_val = $index_val }}
            {{ end }}
            {{ if eq .Params.nav_to_top_weight "last" }}
            {{ $fnav_title := "Start" }}{{ with .Params.nav_to_top_title }}{{ $fnav_title = . }}{{ end }}
            <a class='fn-item' item_index='{{ (add $last_index_val 2) }}' href='./#site-head'>
                <i class="fas fa-arrow-up"></i>
                <span>{{ $fnav_title | safeHTML }}</span>
            </a>
            {{ end }}
        </div>

        <!-- Render single-page content with enhanced sections -->
        {{ range $index_val, $elem_val := $content }}
        {{ if .Title }}
        {{ $fnav_title := .Title }}{{ with .Params.navigation_menu_title }}{{ $fnav_title = . }}{{ end }}
        <div class='post-holder{{ if and (ne .Site.Params.invertSectionColors true) (not (modBool $index_val 2)) }} dark{{ else if and (eq .Site.Params.invertSectionColors true) (modBool $index_val 2) }} dark{{ end }}'>
            <article id='{{ anchorize $fnav_title }}' class='post {{ if eq $index_val 0 }}first{{ end }} {{ if eq (add $index_val 1) (len $content) }}last{{ end }}'>
                <header class="post-header">
                    <h2 class="post-title">{{ .Title | emojify | safeHTML }}</h2>
                    {{ with .Params.section_description }}
                    <p class="post-description">{{ . | safeHTML }}</p>
                    {{ end }}
                </header>
                <section class="post-content">
                    {{ .Content }}

                    <!-- Add quick navigation links for important sections -->
                    {{ if eq $fnav_title "Wissenswertes" }}
                    <div class="quick-links">
                        <h3>Beliebte Artikel</h3>
                        <div class="quick-links-grid">
                            <a href="/wissenswertes/mehr-als-nur-ein-arbeitsplatz/" class="quick-link-card">
                                <i class="fas fa-heart"></i>
                                <span>Mehr als nur ein Arbeitsplatz</span>
                            </a>
                            <a href="/wissenswertes/was-ist-ein-coworking-space/" class="quick-link-card">
                                <i class="fas fa-question-circle"></i>
                                <span>Was ist ein Coworking Space?</span>
                            </a>
                            <a href="/wissenswertes/coworking-am-wochenende/" class="quick-link-card">
                                <i class="fas fa-calendar-weekend"></i>
                                <span>Coworking am Wochenende</span>
                            </a>
                            <a href="/wissenswertes/faq/" class="quick-link-card">
                                <i class="fas fa-info-circle"></i>
                                <span>Häufige Fragen</span>
                            </a>
                        </div>
                    </div>
                    {{ end }}

                    {{ if eq $fnav_title "Digitale Angebote" }}
                    <div class="quick-links">
                        <h3>Unsere Services</h3>
                        <div class="quick-links-grid">
                            <a href="/angebot/virtuelles-buro/" class="quick-link-card">
                                <i class="fas fa-building"></i>
                                <span>Virtuelles Büro</span>
                            </a>
                            <a href="/angebot/lounge-ecke/" class="quick-link-card">
                                <i class="fas fa-couch"></i>
                                <span>Lounge-Ecke</span>
                            </a>
                            <a href="/angebot/workshops-treffen/" class="quick-link-card">
                                <i class="fas fa-users"></i>
                                <span>Workshop-Raum</span>
                            </a>
                            <a href="/wissenswertes/coworking-gutschein/" class="quick-link-card">
                                <i class="fas fa-gift"></i>
                                <span>Gutscheine</span>
                            </a>
                        </div>
                    </div>
                    {{ end }}
                </section>
            </article>
            <div class='post-after{{ if and (ne .Site.Params.invertSectionColors true) (modBool $index_val 2) }} light{{ else if and (eq .Site.Params.invertSectionColors true) (not (modBool $index_val 2)) }} light{{ end }}'></div>
        </div>
        {{ end }}
        {{ end }}
    </main>

    <!-- Enhanced JavaScript for Homepage -->
    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // Sticky navigation for homepage
            const stickyNav = document.getElementById('homepageNav');
            const hero = document.getElementById('site-head');

            function updateStickyNav() {
                if (window.pageYOffset > hero.offsetHeight - 100) {
                    stickyNav.classList.add('visible');
                } else {
                    stickyNav.classList.remove('visible');
                }
            }

            // Enhanced left navigation with active section highlighting
            function updateActiveNavItem() {
                const sections = document.querySelectorAll('.post');
                const navItems = document.querySelectorAll('.fn-item');

                let current = '';
                sections.forEach(section => {
                    const sectionTop = section.offsetTop;
                    const sectionHeight = section.clientHeight;
                    if (window.pageYOffset >= sectionTop - 200) {
                        current = section.getAttribute('id');
                    }
                });

                navItems.forEach(item => {
                    item.classList.remove('active');
                    const href = item.getAttribute('href');
                    if (href && href.includes('#' + current)) {
                        item.classList.add('active');
                    }
                });
            }

            // Mobile navigation toggle
            const mobileToggle = document.getElementById('mobileNavToggle');
            const stickyNavMenu = document.querySelector('.sticky-nav-menu');

            if (mobileToggle) {
                mobileToggle.addEventListener('click', function() {
                    stickyNavMenu.classList.toggle('open');
                    mobileToggle.classList.toggle('open');
                });
            }

            // Smooth scrolling
            document.querySelectorAll('a[href^="#"]').forEach(anchor => {
                anchor.addEventListener('click', function (e) {
                    e.preventDefault();
                    const target = document.querySelector(this.getAttribute('href'));
                    if (target) {
                        target.scrollIntoView({
                            behavior: 'smooth',
                            block: 'start'
                        });
                    }
                });
            });

            // Event listeners
            window.addEventListener('scroll', function() {
                updateStickyNav();
                updateActiveNavItem();
            });

            // Initialize
            updateStickyNav();
            updateActiveNavItem();
        });
    </script>
    {{ end }}